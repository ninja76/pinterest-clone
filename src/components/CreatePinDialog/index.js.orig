import React, { useCallback, useState, setState, useEffect } from "react";
import axios from 'axios';
import Dropzone from 'react-dropzone'
import Button from '@material-ui/core/Button';
import TextField from '@material-ui/core/TextField';
import AppBar from '@material-ui/core/AppBar';
import Toolbar from '@material-ui/core/Toolbar';
import IconButton from '@material-ui/core/IconButton';
import Typography from '@material-ui/core/Typography';
import Dialog from '@material-ui/core/Dialog';
import DialogActions from '@material-ui/core/DialogActions';
import DialogContent from '@material-ui/core/DialogContent';
import DialogContentText from '@material-ui/core/DialogContentText';
import DialogTitle from '@material-ui/core/DialogTitle';
import Grid from '@material-ui/core/Grid';
import GridList from '@material-ui/core/GridList';
import GridListTile from '@material-ui/core/GridListTile';
import DeleteIcon from '@material-ui/icons/Delete';
import CloseIcon from '@material-ui/icons/Close';
import Slide from '@material-ui/core/Slide';
import CloudUploadIcon from '@material-ui/icons/CloudUpload';
import cuid from "cuid";
import useStyles from './styles';

const Transition = React.forwardRef(function Transition(props, ref) {
    return <Slide direction="up" ref={ref} {...props} />;
  });

const getPresignedPostData = (image) => {
  fetch('http://chlover-833630845.us-east-1.elb.amazonaws.com/upload_url', {
    method: 'post',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({key: image.id})
    })
    .then(response => response.text())
    .then(json => {
      const presigndata = json;
      uploadFileToS3(image, presigndata);
    })
    .catch(error => {
      console.log(error);
    });
};

const uploadFileToS3 = (file, presignedPostData) => {
  const formData = new FormData();
  Object.keys(JSON.parse(presignedPostData).fields).forEach(key => {
    if (key == 'key') {
      formData.append(key, file.id);
    } else {
      formData.append(key, JSON.parse(presignedPostData).fields[key]);
    }
  });
  const buffer = Buffer.from(file.src.replace(/^data:image\/\w+;base64,/, ""),'base64');
  console.log(buffer);
  formData.append("file", buffer);

  axios({method: 'post', url: JSON.parse(presignedPostData).url, 
             data: formData},{ headers: { 'Content-Type': 'image/jpeg',
        'Content-Encoding': 'base64' }}).then();
//  const xhr = new XMLHttpRequest();
//  xhr.open("POST", JSON.parse(presignedPostData).url, true);
//  xhr.send(formData);
//  xhr.onload = function() {
//    console.log(this.status);
//  };
};

const submitPin = (pinTitle, pinDescription, image) => {
  fetch('http://chlover-833630845.us-east-1.elb.amazonaws.com/pins', {
    method: 'post',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({title: pinTitle, 
                          description: pinDescription, 
                          imageId: image.id, 
                          url: '',
                          userId: 1})
    })
    .then(response => response.text())
    .then(json => {
    })
    .catch(error => {
      console.log(error);
    });
}

export default function CreatePinDialog(props) {
  let open = props.open;
  const classes = useStyles();

  const [pinTitle, setPinTitle] = useState("");
  const [pinDescription, setPinDescription] = useState("");
  const [pinWebsite, setPinWebsite] = useState("");
  const [pinDestinationLink, setPinDestinationLink] = useState("");
  
  const [images, setImages] = useState([]);

  const handleCreate = () => {
    submitPin(pinTitle, pinDescription, images[0]);
    getPresignedPostData(images[0]);
    props.handleClose();
  };

  const onDrop = useCallback(acceptedFiles => {
    acceptedFiles.map(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        setImages(prevState => [
          ...prevState,
          { id: 'originals/' + cuid() + '.jpg', src: e.target.result }
        ]);
      };
      reader.readAsDataURL(file);
      return file;
    });
  }, [])

  const deleteImage = () => {
      setImages([]);
  }

  function RenderDropzone(props) {
    return <div style={{width: '100%'}}><Dropzone onDrop={onDrop} className={classes.baseStyle}>
                {({getRootProps, getInputProps}) => (
                  <div {...getRootProps()} className={classes.baseStyle}>
                    <CloudUploadIcon/>
                    <input {...getInputProps()} />
                    Drag n drop or click to upload
                  </div>
                )}
              </Dropzone>
              <TextField
                   id="pinWebsite"
                   style={{width: '100%'}}
                   label="or get image from url"
                   placeholder="Enter website"
                   value={pinWebsite}
                   onChange={e => setPinWebsite(e.target.value)}
                   disabled={images.length > 0 ? true:false}
                /></div>
  }

  return (
      <Dialog fullScreen open={open} onClose={props.handleClose} TransitionComponent={Transition}>
        <AppBar className={classes.appBar}>
          <Toolbar>
            <IconButton edge="start" color="inherit" onClick={props.handleClose} aria-label="close">
              <CloseIcon />
            </IconButton>
            <Typography variant="h6" className={classes.title}>
              Create Pin 
            </Typography>
          </Toolbar>
        </AppBar>
        <DialogContent>
          <Grid container justify="center" spacing={3}>
            <Grid item xs={12} md={5} style={{height: 400, alignItems: 'center'}} >
              <Grid container justify="center" spacing={2} style={{paddingTop: 25}}>
                {images.length > 0 ? (
                  <div>
                    <IconButton
                      onClick={deleteImage}
                    >
                      <DeleteIcon />
                    </IconButton>
                    <img src={images[0].src} style={{width: 250, borderRadius: 20}}/>
                  </div>
                ) : (
                  <RenderDropzone/>
                )}
              </Grid>
            </Grid>
            <Grid item xs={12} md={5}>
              <div>
                <div>
                <TextField
                  id="pinTitle"
                  label="Pin Title"
                  style={{width: '100%'}}
                  value={pinTitle}
                  onChange={e => setPinTitle(e.target.value)}
                />
                </div>
              </div>
              <div>
                <TextField
                  id="pinDescription"
                  label="Tell us about your pin"
                  multiline
                  rowsMax="4"
                  className={classes.textField}
                  margin="normal"
                  style={{width: '100%'}}
                  value={pinDescription}
                  onChange={e => setPinDescription(e.target.value)}
                />
                <div>
                <TextField
                  id="pinDestinationLink"
                  style={{width: '100%'}}
                  label="Destination Link"
                  value={pinDestinationLink}
                  onChange={e => setPinDestinationLink(e.target.value)}
                />
                </div>
              </div>
            </Grid>
          </Grid>
        </DialogContent>
        <DialogActions color='transparent'>
          <Button onClick={props.handleClose} color="primary">
            Cancel
          </Button>
          <Button onClick={handleCreate} color="primary">
           Create 
          </Button>
        </DialogActions>
      </Dialog>
  );
}
